{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot</title>
    <link rel="stylesheet" href="{% static 'gpt/style.css' %}">
    <link rel="stylesheet" href="{% static 'gpt/chatstyles.css' %}">
</head>
<body>
    <nav class="navbar navbar-default">
        <div class="container">
            <div id="navbar" class="collapse navbar-collapse">
                <ul class="nav navbar-nav">
                    <li class="active"><a href="/main/">Home</a></li>
                </ul>
                <ul class="nav navbar-nav navbar-right">
                    {% if not user.is_authenticated %}
                        <li><a href="{% url 'signup' %}">회원 가입 </a> </li>
                        <li><a href="{% url 'login' %}?next={{request.path}}">로그인</a></li>
                    {% else %}
                        {% if user.is_superuser %}
                        <li><a href="{% url 'admin:index' %}">관리자 페이지</a></li>
                        {% endif %}
                    <li><a href="">{{user}}님!</a> </li> 
                    <li><a href="{% url 'profile' %}">내정보</a> </li>
                    <li>
                        <form action="{% url 'logout' %}?next={{request.path}}" method="post">
                            {% csrf_token %}
                            <button type="submit">로그 아웃</button>
                        </form>
                    </li>
                    {% endif %}
                 </ul>
                </div>
        </div>
    </nav>
    <div class="container">
        <div class="sidebar">
            <button onclick="displayEmptyChat()">New Chat</button>
            <ul class="chat-list">
                {% for chat in chats %}
                    <li class="chat" onclick="loadChat({{ chat.id }})">
                        <div class="bubble">{{ chat.thumbnail }}</div>
                    </li>
                {% endfor %}
            </ul>
        </div>
        <div class="chat-container">
            <div class="chat-header">Chatbot</div>
            <div class="chat-messages" id="chat-messages">
                <!-- 이전 메시지 표시 -->
                <ul class="messages">
                    {% for message in messages %}
                        <li class="message {% if message.user == 'User' %}user{% else %}bot{% endif %}">
                            <div class="bubble">{{ message.text }}</div>
                        </li>
                    {% endfor %}
                </ul>
            </div>
            <div class="input-container">
                <textarea id="message-input" placeholder="Type a message..."></textarea>
                <button onclick="sendMessage()">Send</button>
                <a href="{% url 'chatgpt:download_chat_history' %}" class="button-link">Save</a>
            </div>            
            
    </div>
    <script>
        let chatId = "{{ chat_id|default_if_none:'' }}";
        let userId = "{{ user_id|default_if_none:'' }}";

        if (chatId === "") chatId = null;
        if (userId === "") userId = 'admin';

        function loadChat(id) {
            console.log("Loading chat with chat_id:", id);
            fetch(`/chatgpt/chat_view/${userId}/${id}/`)
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const messages = doc.querySelector('.chat-messages').innerHTML;
                    document.querySelector('.chat-messages').innerHTML = messages;
                    chatId = id;
                    history.pushState(null, '', `/chatgpt/chat_view/${userId}/${id}/`);
                });
        }

        function displayEmptyChat() {
            document.querySelector('.chat-messages').innerHTML = '<ul class="messages"></ul>';
            chatId = null; // 명시적으로 chatId를 null로 설정
            history.pushState(null, '', `/chatgpt/chat_view/${userId}/`);
        }

        function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value;

            if (message.trim() === '') return;

            const messagesContainer = document.querySelector('.messages');

            // 사용자 메시지를 화면에 즉시 추가
            const userMessage = document.createElement('li');
            userMessage.className = 'message user';
            userMessage.innerHTML = `<div class="bubble">${message}</div>`;
            messagesContainer.appendChild(userMessage);

            // "typing..." 애니메이션 추가
            const typingIndicator = document.createElement('li');
            typingIndicator.className = 'message dot typing';
            typingIndicator.innerHTML = `
                <div class="bubble">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>`;
            messagesContainer.appendChild(typingIndicator);

            // 스크롤을 가장 아래로 이동
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            userMessage.scrollIntoView({ behavior: 'smooth' });

            // 입력 필드 초기화
            input.value = '';

            // 서버에 메시지 전송
            let url = "/chatgpt/api/chat/";
            let bodyContent = `question=${encodeURIComponent(message)}&user_id=${encodeURIComponent(userId)}`;
            if (chatId) {
                bodyContent += `&chat_id=${encodeURIComponent(chatId)}`;
            }

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: bodyContent
            })
            .then(response => response.json())
            .then(data => {
                // "typing..." 애니메이션 제거
                messagesContainer.removeChild(typingIndicator);

                if (data.success) {
                    if (!chatId) {
                        chatId = data.chat_id;  // 새로운 chat_id 설정
                        history.pushState(null, '', `/chatgpt/chat_view/${userId}/${chatId}/`);
                        window.location.href = `/chatgpt/chat_view/${userId}/${chatId}/`;  // URL 변경
                    }
                    const botMessage = document.createElement('li');
                    botMessage.className = 'message bot';
                    botMessage.innerHTML = `<div class="bubble">${data.message}</div>`;
                    messagesContainer.appendChild(botMessage);

                    // 스크롤을 가장 아래로 이동
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    botMessage.scrollIntoView({ behavior: 'smooth' });
                } else {
                    alert('Failed to send message.');
                }
            })
            .catch(error => {
                console.error('There has been a problem with your fetch operation:', error);
                messagesContainer.removeChild(typingIndicator);
            });
        }

        // 채팅방 추가
        function addChatRoom() {
            const roomName = prompt("Enter chat room name:");
            //const input = document.getElementById('message-input');
            //const roomName = input.value;
            roomName
            if (roomName) {
                const chatRooms = document.getElementById('chat-rooms');
                const newRoom = document.createElement('li');
                newRoom.className = 'chat-room';
                newRoom.textContent = roomName;
                newRoom.onclick = function() { selectChatRoom(roomName) };
                chatRooms.appendChild(newRoom);
            }
        }

        function selectChatRoom(roomId) {
            // 이 함수에서 선택한 채팅방에 맞게 메시지를 로드하는 로직
            console.log('Selected chat room:', roomId);
        }

        // Enter 키로 메시지 전송
        document.getElementById('message-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    </script>
</body>
</html> 

